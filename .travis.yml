language: node_js
node_js:
  - "14"
cache:
  directories:
    - node_modules
    - ${SERVICE_PATH}/node_modules
install:
    - yarn global add serverless
    - travis_retry yarn install
    - cd ${SERVICE_PATH}
    - travis_retry yarn install
    - cd -

.feature_env: &feature_env
  - CLUSTER=development
  - ENVIRONMENT=development
  - TAG=${TRAVIS_COMMIT}
  - AWS_REGION=eu-west-1
  - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_DEVELOPMENT}
  - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_DEVELOPMENT}
  - AWS_DEFAULT_REGION=${AWS_REGION}

.staging_env: &staging_env
  - CLUSTER=staging
  - ENVIRONMENT=staging
  - TAG=${TRAVIS_COMMIT}
  - AWS_REGION=eu-west-1
  - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_STAGING}
  - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_STAGING}
  - AWS_DEFAULT_REGION=${AWS_REGION}

.production_env: &production_env
  - CLUSTER=production
  - ENVIRONMENT=production
  - TAG=${TRAVIS_COMMIT}
  - AWS_REGION=us-west-2
  - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_PRODUCTION}
  - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_PRODUCTION}
  - AWS_DEFAULT_REGION=${AWS_REGION}

jobs:
  include:
    - stage: test
      name: Run tests
      if: type = pull_request
      env: *feature_env
      script:
        - yarn run jest
    
    - stage: deploy
      name: Deploy to feature env
      if: type = pull_request AND (head_branch =~ ^bug/ OR head_branch =~ ^chore/ OR head_branch =~ ^feature/) AND branch = master
      env: *feature_env
      provider: script
      script:
        - SERVICE_PATH="init-user"
        - bash bin/deploy
        - SERVICE_PATH="create-post"
        - bash bin/deploy

#       name: "Deploy User Init API"
#       env:
#         - SERVICE_PATH="init-user"
#     -
#       name: "Deploy Create Post API"
#       env:
#         - SERVICE_PATH="create-post"
# deploy:
#   provider: script
#   script: bash bin/deploy
#   if: branch = master AND type = push